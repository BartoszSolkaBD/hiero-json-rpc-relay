// SPDX-License-Identifier: Apache-2.0

import { ConfigService } from '@hashgraph/json-rpc-config-service/dist/services';
import { expect } from 'chai';
import * as sinon from 'sinon';

import { DebugImpl } from '../../../src/lib/debug';
import { RequestDetails } from '../../../src/lib/types';
import { mockWorkersPool } from '../../helpers';
import { generateEthTestEnv } from '../eth/eth-helpers';

describe('debug_getRawReceipts', function () {
  this.timeout(10000);

  const { cacheService, mirrorNodeInstance, commonService, logger } = generateEthTestEnv(true);

  const requestDetails = new RequestDetails({ requestId: 'debug_getRawReceipts', ipAddress: '0.0.0.0' });

  let debugService: DebugImpl;

  // Pre‑captured Quicknode debug_getRawReceipts payload for Monad block 0x23592c0
  const expectedRawReceipts = [
    '0xf901c50180b9010000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000200000000000000000000000000000000000000000002000000000008000000000000000000000000020000000000000000000000000000000000000010000000000000000000000000000000000004000000000000000000400000000000000000000000000000000000000000000000000004000000010000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f8bef8bc940000000000000000000000000000000000001000f863a03a420a01486b6b28d6ae89c51f5c3bde3e0e74eecbb646a0c481ccba3aae3754a00000000000000000000000000000000000000000000000000000000000000056a00000000000000000000000006f49a8f621353f12378d0046e7d7e4b9b249dc9eb840000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002e6',
    '0x02f90241018303a980b9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000042000000000000000000f90136f89994368ee51e47a594fe1e9908b48228748a30bc7ca4e1a0f36866d965ee70c8632ff558f5cf8d41ee9ca1d0d0bc7700786e57be60747390b8600000000000000000000000000000000000000000000000000000003fb482bae245544800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000069208301f89994368ee51e47a594fe1e9908b48228748a30bc7ca4e1a0f36866d965ee70c8632ff558f5cf8d41ee9ca1d0d0bc7700786e57be60747390b860000000000000000000000000000000000000000000000000000007a4dfeb5fe242544300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000069208301',
  ];

  // Minimal “mirror-node-like” execution data that should lead to the above
  // raw receipts when passed through blockWorker.getRawReceipts.
  const QUICKNODE_BLOCK_HASH = '0x0aae422316a0c19edb48cbb72e26614202a8b56daefb21c3e9920ede19c7670c';
  const QUICKNODE_BLOCK_NUMBER_HEX = '0x23592c0';

  const quicknodeBlock = {
    count: 2,
    timestamp: {
      from: '1690000000.000000000',
      to: '1690000001.000000000',
    },
  };

  const quicknodeContractResults = [
    {
      hash: '0x6ae0bb89e2b7170f243f7e48fe413e46ba26e6d1d24f6bb53746967168474ea3',
      gas_used: 0,
      bloom:
        '0x00000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000200000000000000000000000000000000000000000002000000000008000000000000000000000000020000000000000000000000000000000000000010000000000000000000000000000000000004000000000000000000400000000000000000000000000000000000000000000000000004000000010000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
      root: '0x01',
      status: '0x1',
      transaction_index: 0,
      type: 0,
      block_gas_used: 0,
      result: 'SUCCESS',
    },
    {
      hash: '0x92f28ebdf21ba386757b8a17292791ec70edce1dd0828f9202ccead768006e6a',
      gas_used: parseInt('0x3a980', 16),
      bloom:
        '0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000042000000000000000000',
      root: '0x01',
      status: '0x1',
      transaction_index: 1,
      type: 2,
      block_gas_used: parseInt('0x3a980', 16),
      result: 'SUCCESS',
    },
  ];

  const quicknodeLogs = [
    {
      address: '0x0000000000000000000000000000000000001000',
      topics: [
        '0x3a420a01486b6b28d6ae89c51f5c3bde3e0e74eecbb646a0c481ccba3aae3754',
        '0x0000000000000000000000000000000000000000000000000000000000000056',
        '0x0000000000000000000000006f49a8f621353f12378d0046e7d7e4b9b249dc9e',
      ],
      data: '0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002e6',
      blockHash: QUICKNODE_BLOCK_HASH,
      blockNumber: QUICKNODE_BLOCK_NUMBER_HEX,
      blockTimestamp: '0x69208301',
      transactionHash: '0x6ae0bb89e2b7170f243f7e48fe413e46ba26e6d1d24f6bb53746967168474ea3',
      transactionIndex: '0x0',
      logIndex: '0x0',
      removed: false,
    },
    {
      address: '0x368ee51e47a594fe1e9908b48228748a30bc7ca4',
      topics: ['0xf36866d965ee70c8632ff558f5cf8d41ee9ca1d0d0bc7700786e57be60747390'],
      data: '0x0000000000000000000000000000000000000000000000000000003fb482bae245544800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000069208301',
      blockHash: QUICKNODE_BLOCK_HASH,
      blockNumber: QUICKNODE_BLOCK_NUMBER_HEX,
      blockTimestamp: '0x69208301',
      transactionHash: '0x92f28ebdf21ba386757b8a17292791ec70edce1dd0828f9202ccead768006e6a',
      transactionIndex: '0x1',
      logIndex: '0x1',
      removed: false,
    },
    {
      address: '0x368ee51e47a594fe1e9908b48228748a30bc7ca4',
      topics: ['0xf36866d965ee70c8632ff558f5cf8d41ee9ca1d0d0bc7700786e57be60747390'],
      data: '0x000000000000000000000000000000000000000000000000000007a4dfeb5fe242544300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000069208301',
      blockHash: QUICKNODE_BLOCK_HASH,
      blockNumber: QUICKNODE_BLOCK_NUMBER_HEX,
      blockTimestamp: '0x69208301',
      transactionHash: '0x92f28ebdf21ba386757b8a17292791ec70edce1dd0828f9202ccead768006e6a',
      transactionIndex: '0x1',
      logIndex: '0x2',
      removed: false,
    },
  ];

  before(async function () {
    await mockWorkersPool(mirrorNodeInstance, commonService, cacheService);

    debugService = new DebugImpl(mirrorNodeInstance, logger, cacheService, ConfigService.get('CHAIN_ID'));
  });

  beforeEach(function () {
    sinon.restore();
    cacheService.clear();
  });

  it('produces raw receipts matching the pre-captured Quicknode payload for Monad block 0x23592c0', async function () {
    sinon.stub(commonService, 'getHistoricalBlockResponse').resolves(quicknodeBlock as any);

    sinon.stub(mirrorNodeInstance, 'getContractResults').resolves(quicknodeContractResults as any[]);

    sinon.stub(commonService, 'getLogsWithParams').resolves(quicknodeLogs as any[]);

    const result = await debugService.getRawReceipts(QUICKNODE_BLOCK_NUMBER_HEX, requestDetails);

    expect(result).to.not.be.null;
    expect(result).to.have.lengthOf(2);
    expect(result).to.deep.equal(expectedRawReceipts);
  });
});
